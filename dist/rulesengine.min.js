(function(e,t){if(typeof define==="function"&&define.amd){define([],t)}else if(typeof module==="object"&&module.exports){module.exports=t()}else{e.RulesEngine=t()}})(this,function(){var e=function(){var e=[];function t(){while(e.length){e[0]();e.shift()}}var n=function(){if(typeof MutationObserver!=="undefined"){var e=document.createElement("div");var n=new MutationObserver(t);n.observe(e,{attributes:true});return function(t){e.setAttribute("a",0)}}if(typeof setImmediate!=="undefined"){return function(){setImmediate(t)}}return function(){setTimeout(t,0)}}();return function(t){e.push(t);if(e.length==1)n()}}();var jQuery;try{if(typeof $==="undefined"){var t=require("jsdom-no-contextify");t.env("",function(e,t){if(e){console.error(e);return}$=require("jquery")(t);jQuery=$})}}catch(e){jQuery=function(e,t){if(typeof define==="function"&&define.amd){define(t);return}var n=t();if(typeof module==="object"){module.exports=n;return}e[n.name]=n}(this,function(){var e="done fail isResolved isRejected promise then always pipe".split(" ");var t=[].slice;var jQuery={_Deferred:function(){var e=[],t,n,r,i={done:function(){if(!r){var n=arguments,u,s,o,f,a;if(t){a=t;t=0}for(u=0,s=n.length;u<s;u++){o=n[u];f=typeof o;if(Array.isArray(o))f="array";if(f==="array"){i.done.apply(i,o)}else if(f==="function"){e.push(o)}}if(a){i.resolveWith(a[0],a[1])}}return this},resolveWith:function(i,u){if(!r&&!t&&!n){u=u||[];n=1;try{while(e[0]){e.shift().apply(i,u)}}finally{t=[i,u];n=0}}return this},resolve:function(){i.resolveWith(this,arguments);return this},isResolved:function(){return!!(n||t)},cancel:function(){r=1;e=[];return this}};return i},Deferred:function(t){var n=jQuery._Deferred(),r=jQuery._Deferred(),i;var u={then:function(e,t){n.done(e).fail(t);return this},always:function(){return n.done.apply(n,arguments).fail.apply(this,arguments)},fail:r.done,rejectWith:r.resolveWith,reject:r.resolve,isRejected:r.isResolved,pipe:function(e,t){return jQuery.Deferred(function(r){var i={done:[e,"resolve"],fail:[t,"reject"]};var u=function(e,t){var i=t[0],u=t[1],s;if(typeof i==="function"){n[e](function(){s=i.apply(this,arguments);if(s&&typeof s.promise==="function"){s.promise().then(r.resolve,r.reject)}else{r[u](s)}})}else{n[e](r[u])}};for(var s in i){u(s,i[s])}}).promise()},promise:function(t){if(t==null){if(i){return i}i=t={}}var r=e.length;while(r--){t[e[r]]=n[e[r]]}return t}};for(var s in u){n[s]=u[s]}n.done(r.cancel).fail(n.cancel);delete n.cancel;if(t){t.call(n,n)}return n},when:function(e){var n=arguments,r=0,i=n.length,u=i,s=i<=1&&e&&typeof e.promise==="function"?e:jQuery.Deferred();function o(e){return function(r){n[e]=arguments.length>1?t.call(arguments,0):r;if(!--u){s.resolveWith(s,t.call(n,0))}}}if(i>1){for(;r<i;r++){if(n[r]&&typeof n[r].promise==="function"){n[r].promise().then(o(r),s.reject)}else{--u}}if(!u){s.resolveWith(s,n)}}else if(s!==e){s.resolveWith(s,i?[e]:[])}return s.promise()}};return jQuery})}var RulesEngine=function(e){this.facts={};this.rules=[];this.rulesMap={};this.evaluatedRules={};this.prevValues={};this.prevToggle={};this.events={};this.queue=[];this.asyncTimeout=3e3;this.engineTimeout=1e4;this.isEvaluatingFlg=false;this.isRunningFlg=false;if(e!==undefined){jQuery=e}else if(jQuery.Deferred===undefined){throw new Error("No jQuery.Deferred or shim found.")}};RulesEngine.prototype.constructor=RulesEngine;RulesEngine.prototype._log=function(e,t){if(typeof console==="undefined"||typeof console[e]!=="function")return;console[e](t)};RulesEngine.prototype.updateFacts=function(e){if(this.isRunningFlg){return this._enqueue(this.updateFacts,this,[e])}this.isRunningFlg=true;var t=this;var n=jQuery.Deferred();if(typeof e==="object"){this.facts=e;this._run().always(function(){n.resolve();t._dequeue()});return n}};RulesEngine.prototype._deepCopy=function(e){return JSON.parse(JSON.stringify(e))};RulesEngine.prototype.getFacts=function(e){var t=this._deepCopy(this.facts);if(e===undefined||typeof e!=="string")return t;var n=e.split(".");for(var r=0;r<n.length;r++){t=t[n[r]];if(t===undefined)return undefined}return t};RulesEngine.prototype.addRule=function(t,n,r){if(typeof t!=="string")return;var i;var u=this;if(typeof n!=="function"){i=function(){var t=jQuery.Deferred();e(t.resolve);return t}}else if((n(this.facts)||{}).then===undefined){i=function(t){return function(n){var r=jQuery.Deferred();try{if(t(n)){e(r.resolve)}else{e(r.reject)}return r}catch(t){u._log("error",t);e(function(){if(r.state()==="pending")r.reject()});return r}}}(n)}else{i=function(r){var i=jQuery.Deferred();try{n(r).done(function(){i.resolve()}).fail(function(){i.reject()});setTimeout(function(){if(i.state()==="pending"){i.reject();u._log("error","Timed out for evaluation of function: "+t)}},u.asyncTimeout);return i}catch(t){u._log("error",t);e(function(){if(i.state()==="pending")i.reject()});return i}}}if(Array.isArray(r)||typeof r!=="object"){r={}}if(r.priority===undefined){r.priority=9}if(r.toggle===undefined){r.toggle=true}if(!Array.isArray(r.events)){if(r.events!==undefined){r.events=[r.events]}else{r.events=[]}}if(this.rulesMap[t]===undefined){this.rules.push(t)}if(Array.isArray(r.events)){for(var s=0;s<r.events.length;s++){if(typeof r.events[s]==="string"){this.addEvent(r.events[s])}}}else if(typeof r.events==="string"){this.addEvent(r.events)}if(this.events[t]===undefined){this.addEvent(t);Object.defineProperty(this.events[t],"_auto_generated_",{value:true})}r.events.push(t);this.rulesMap[t]={name:t,events:r.events,test:i,priority:r.priority,conditions:r.conditions,toggle:r.toggle};this.prevToggle[t]=new Date};RulesEngine.prototype.addRules=function(e){if(!Array.isArray(e))return false;for(var t=0;t<e.length;t++){if(Array.isArray(e[t])){this.addRule.apply(this,e[t])}}};RulesEngine.prototype.removeRule=function(e){for(var t=0;t<this.rules.length;t++){if(this.rules[t]===e){this.rules.splice(t,1)}}delete this.rulesMap[e];if(this.events[e]&&this.events[e]._auto_generated_===true){delete this.events[e]}};RulesEngine.prototype.addEvent=function(e){this.events[e]={bound:{}}};RulesEngine.prototype.addEvents=function(e){if(!Array.isArray(e))return false;for(var t=0;t<e.length;t++){if(Array.isArray(e[t])){this.addEvent.apply(this,e[t])}else{this.addEvent.call(this,e[t])}}};RulesEngine.prototype.removeEvent=function(e){delete this.events[e]};RulesEngine.prototype.emit=function(e,t){if(t){if(this.events[e].bound._evaluation_event!==undefined){this.events[e].bound._evaluation_event(this.facts);return true}return false}for(var n in this.events[e].bound){this.events[e].bound[n](this.facts)}return false};RulesEngine.prototype.on=function(e,t,n){if(n===undefined&&typeof t==="function"){n=t;t=e}this.events[e].bound[t]=n};RulesEngine.prototype.off=function(e,t){if(t!==undefined){delete this.events[e].bound[t]}else{this.events[e].bound={}}};RulesEngine.prototype.run=function(){if(this.isRunningFlg){return this._enqueue(this.run,this,[])}else{var e=jQuery.Deferred();var t=this;this.isRunningFlg=true;this._run().always(function(){e.resolve();t._dequeue()});return e}};RulesEngine.prototype._run=function(){var e=false;var t=this;t.prevValues={};for(var n in t.evaluatedRules){t.prevValues[n]=t.evaluatedRules[n]}t.evaluatedRules={};t.rules.sort(function(e,n){if(t.rulesMap[e].priority>t.rulesMap[n].priority)return 1;if(t.rulesMap[e].priority<t.rulesMap[n].priority)return-1;if(t.prevToggle[e]<t.prevToggle[n])return 1;if(t.prevToggle[e]>t.prevToggle[n])return-1;return 0});var r=function(n){var u=jQuery.Deferred();if(e)return u.resolve();if(n===undefined){return u.resolve()}var s=[];if(n.all!==undefined){n.all.forEach(function(e){s.push(r(e))});jQuery.when.apply(jQuery,s).done(function(){u.resolve()}).fail(function(){u.reject()})}else if(n.any!==undefined){n.any.forEach(function(e){s.push(function(){var t=jQuery.Deferred();r(e).done(function(){t.reject()}).fail(function(){t.resolve()});return t}())});jQuery.when.apply(jQuery,s).done(function(){u.reject()}).fail(function(){u.resolve()})}else{var o=n;var f=false;if(typeof o!=="string"){u.reject()}else{if(o.charAt(0)==="!"){f=true;o=o.slice(1)}if(t.rulesMap[o]!==undefined&&f===false){i(t.rulesMap[o]).done(function(){u.resolve()}).fail(function(){u.reject()})}else if(t.rulesMap[o]!==undefined&&f===true){i(t.rulesMap[o]).done(function(){u.reject()}).fail(function(){u.resolve()})}else{u.reject()}}}return u};var i=function(n){var i=jQuery.Deferred();if(e)return i.resolve();if(n===undefined)return i.resolve();if(t.evaluatedRules[n.name]===true)return i.resolve();if(t.evaluatedRules[n.name]===false)return i.reject();if(t.evaluatedRules[n.name]!==undefined&&typeof t.evaluatedRules[n.name].always==="function"){t.evaluatedRules[n.name].done(function(){i.resolve()}).fail(function(){i.reject()});return i}t.evaluatedRules[n.name]=i;var u=function(t,n,r){t.test(n.facts).done(function(){n.evaluatedRules[t.name]=true;if(n.prevValues[t.name]!==true)n.prevToggle[t.name]=new Date;if(!t.toggle||n.prevValues[t.name]!==true||((n.events[t.name]||{}).bound||{})._evaluation_event!==undefined){for(var i=0;i<t.events.length;i++){if(n.emit(t.events[i],n.isEvaluatingFlg)===true)e=true}}r.resolve()}).fail(function(){n.evaluatedRules[t.name]=false;if(n.prevValues[t.name]!==false)n.prevToggle[t.name]=new Date;if(((n.events[t.name]||{}).bound||{})._evaluation_event!==undefined)e=true;r.reject()})};if(n.conditions!==undefined){r(n.conditions).done(function(){u(n,t,i)}).fail(function(){t.evaluatedRules[n.name]=false;if(((t.events[n.name]||{}).bound||{})._evaluation_event!==undefined)e=true;i.reject()})}else{u(n,t,i)}return i};if(Object.keys(t.rulesMap).length===0){return jQuery.Deferred().resolve()}var u=jQuery.Deferred();var s=function(e,n){n(e).always(function(){if(e<t.rules.length){s(e+1,n)}else{u.resolve()}})};s(0,function(e){return i(t.rulesMap[t.rules[e]])});setTimeout(function(){if(u.state()==="pending"){t._log("error","Rules engine timed out.");u.reject()}},this.engineTimeout);return u};RulesEngine.prototype.evaluate=function(e,t){if(this.isRunningFlg){return this._enqueue(this.evaluate,this,[e,t])}this.isRunningFlg=true;this.isEvaluatingFlg=true;var n=jQuery.Deferred();var r=this.facts;var i={};for(var u in this.evaluatedRules){i[u]=this.evaluatedRules[u]}var s={};for(var u in this.prevValues){s[u]=this.prevValues[u]}var o={};for(var u in this.prevToggle){o[u]=this.prevToggle[u]}var f;var a=this;if(t!==undefined){this.facts=t}if(this.rulesMap[e]&&this.events[e]._auto_generated_===true){f=this.rulesMap[e].priority;this.rulesMap[e].priority=-Infinity}this.evaluatedRules={};this.prevValues={};this.on(e,"_evaluation_event",function(e){n.resolve()});this._run("evaluate").always(function(){a.off(e,"_evaluation_event");a.facts=r;a.evaluatedRules=i;a.prevValues=s;a.prevToggle=o;if(f!==undefined){a.rulesMap[e].priority=f}a.isEvaluatingFlg=false;if(n.state()==="pending"){n.reject()}a._dequeue()});return n};RulesEngine.prototype._enqueue=function(e,t,n){var r=jQuery.Deferred();this.queue.push([e,t,n,r]);return r};RulesEngine.prototype._dequeue=function(){this.isRunningFlg=false;if(this.queue.length===0)return;var e=this.queue.shift();e[0].apply(e[1],e[2]).done(function(){e[3].resolve()}).fail(function(){e[3].reject()})};return RulesEngine});
