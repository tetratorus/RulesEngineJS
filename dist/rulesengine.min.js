(function(root,e){if(typeof define==="function"&&define.amd){define([],e)}else if(typeof module==="object"&&module.exports){module.exports=e()}else{root.RulesEngine=e()}})(this,function(){!function(e){"use strict";function t(e){if(e){var t=this;e(function(e){t.resolve(e)},function(e){t.reject(e)})}}function n(e,t){if("function"==typeof e.y)try{var n=e.y.call(u,t);e.p.resolve(n)}catch(t){e.p.reject(t)}else e.p.resolve(t)}function i(e,t){if("function"==typeof e.n)try{var n=e.n.call(u,t);e.p.resolve(n)}catch(t){e.p.reject(t)}else e.p.reject(t)}var r,u,s="fulfilled",o="rejected",a="undefined",f=function(){function t(){for(;n.length-i;){try{n[i]()}catch(t){e.console&&e.console.error(t)}n[i++]=u,i==r&&(n.splice(0,r),i=0)}}var n=[],i=0,r=1024,s=function(){if(typeof MutationObserver!==a){var e=document.createElement("div"),n=new MutationObserver(t);return n.observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}}return typeof setImmediate!==a?function(){setImmediate(t)}:function(){setTimeout(t,0)}}();return function(e){n.push(e),n.length-i==1&&s()}}();t.prototype={resolve:function(e){if(this.state===r){if(e===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var t=this;if(e&&("function"==typeof e||"object"==typeof e))try{var i=!0,u=e.then;if("function"==typeof u)return void u.call(e,function(e){i&&(i=!1,t.resolve(e))},function(e){i&&(i=!1,t.reject(e))})}catch(e){return void(i&&this.reject(e))}this.state=s,this.v=e,t.c&&f(function(){for(var i=0,r=t.c.length;r>i;i++)n(t.c[i],e)})}},reject:function(n){if(this.state===r){this.state=o,this.v=n;var u=this.c;u?f(function(){for(var e=0,t=u.length;t>e;e++)i(u[e],n)}):!t.suppressUncaughtRejectionError&&e.console&&e.console.log("You upset Zousan. Please catch rejections: ",n,n?n.stack:null)}},then:function(e,u){var o=new t,a={y:e,n:u,p:o};if(this.state===r)this.c?this.c.push(a):this.c=[a];else{var l=this.state,c=this.v;f(function(){l===s?n(a,c):i(a,c)})}return o},catch:function(e){return this.then(null,e)},finally:function(e){return this.then(e,e)},timeout:function(e,n){n=n||"Timeout";var i=this;return new t(function(t,r){setTimeout(function(){r(Error(n))},e),i.then(function(e){t(e)},function(e){r(e)})})}},t.resolve=function(e){var n=new t;return n.resolve(e),n},t.reject=function(e){var n=new t;return n.reject(e),n},t.all=function(e){function n(n,s){n&&"function"==typeof n.then||(n=t.resolve(n)),n.then(function(t){i[s]=t,r++,r==e.length&&u.resolve(i)},function(e){u.reject(e)})}for(var i=[],r=0,u=new t,s=0;s<e.length;s++)n(e[s],s);return e.length||u.resolve(i),u},typeof module!=a&&module.exports&&(module.exports=t),e.define&&e.define.amd&&e.define([],function(){return t}),e.Zousan=t,t.soon=f}("undefined"!=typeof global?global:this);var RulesEngine=function(){this.Zousan=Zousan;this.facts={};this.rules=[];this.rulesMap={};this.evaluatedRules={};this.prevValues={};this.prevToggle={};this.events={};this.queue=[];this.asyncTimeout=3e3;this.engineTimeout=1e4;this.isEvaluatingFlg=false;this.isRunningFlg=false};RulesEngine.prototype.constructor=RulesEngine;RulesEngine.prototype._log=function(e,t){if(typeof console==="undefined"||typeof console[e]!=="function")return;console[e](t)};RulesEngine.prototype.updateFacts=function(e){if(this.isRunningFlg){return this._enqueue(this.updateFacts,this,[e])}this.isRunningFlg=true;var t=this;var n=new Zousan;if(typeof e==="object"){this.facts=e;this._run("updateFacts").finally(function(){n.resolve();t._dequeue()});return n}};RulesEngine.prototype._deepCopy=function(e){return JSON.parse(JSON.stringify(e))};RulesEngine.prototype.getFacts=function(e){var t=this._deepCopy(this.facts);if(e===undefined||typeof e!=="string")return t;var n=e.split(".");for(var i=0;i<n.length;i++){t=t[n[i]];if(t===undefined)return undefined}return t};RulesEngine.prototype.addRule=function(e,t,n){if(typeof e!=="string")return;this.removeRule(e);var i;var r=this;if(Array.isArray(n)||typeof n!=="object"){n={}}if(n.async===undefined){n.async=false}if(typeof t!=="function"){i=function(){var e=new Zousan;Zousan.soon(function(){e.resolve()});return e}}else if(!n.async){i=function(e){return function(t){var n=new Zousan;try{if(e(t)){Zousan.soon(function(){n.resolve()})}else{Zousan.soon(function(){n.reject()})}}catch(e){r._log("error",e);Zousan.soon(function(){if(n.state===undefined)n.reject()})}return n}}(t)}else{i=function(n){var i=new Zousan;try{t(n).then(function(){i.resolve()},function(){i.reject()});setTimeout(function(){if(i.state===undefined){i.reject();r._log("error","Timed out for evaluation of function: "+e)}},r.asyncTimeout)}catch(e){r._log("error",e);Zousan.soon(function(){if(i.state===undefined)i.reject()})}return i}}if(n.priority===undefined){n.priority=9}if(n.toggle===undefined){n.toggle=true}if(!Array.isArray(n.events)){if(n.events!==undefined){n.events=[n.events]}else{n.events=[]}}if(this.rulesMap[e]===undefined){this.rules.push(e)}if(Array.isArray(n.events)){for(var u=0;u<n.events.length;u++){if(typeof n.events[u]==="string"){this.addEvent(n.events[u])}}}else if(typeof n.events==="string"){this.addEvent(n.events)}if(this.events[e]===undefined){this.addEvent(e);Object.defineProperty(this.events[e],"_auto_generated_",{value:true})}n.events.push(e);this.rulesMap[e]={name:e,events:n.events,test:i,priority:n.priority,conditions:n.conditions,toggle:n.toggle};this.prevToggle[e]=new Date;delete this.evaluatedRules[e];delete this.prevValues[e]};RulesEngine.prototype.addRules=function(e){if(!Array.isArray(e))return false;for(var t=0;t<e.length;t++){if(Array.isArray(e[t])){this.addRule.apply(this,e[t])}}};RulesEngine.prototype.removeRule=function(e){for(var t=0;t<this.rules.length;t++){if(this.rules[t]===e){this.rules.splice(t,1)}}delete this.evaluatedRules[e];delete this.prevValues[e];delete this.prevToggle[e];delete this.rulesMap[e];if(this.events[e]&&this.events[e]._auto_generated_===true){delete this.events[e]}};RulesEngine.prototype.addEvent=function(e){this.events[e]={bound:{}}};RulesEngine.prototype.addEvents=function(e){if(!Array.isArray(e))return false;for(var t=0;t<e.length;t++){if(Array.isArray(e[t])){this.addEvent.apply(this,e[t])}else{this.addEvent.call(this,e[t])}}};RulesEngine.prototype.removeEvent=function(e){delete this.events[e]};RulesEngine.prototype.emit=function(e,t){if(t){if(this.events[e].bound._evaluation_event!==undefined){this.events[e].bound._evaluation_event(this.facts);return true}return false}for(var n in this.events[e].bound){this.events[e].bound[n](this.facts)}return false};RulesEngine.prototype.on=function(e,t,n){if(n===undefined&&typeof t==="function"){n=t;t=e}this.events[e].bound[t]=n};RulesEngine.prototype.off=function(e,t){if(t!==undefined){delete this.events[e].bound[t]}else{this.events[e].bound={}}};RulesEngine.prototype.run=function(){if(this.isRunningFlg){return this._enqueue(this.run,this,[])}else{var e=new Zousan;var t=this;this.isRunningFlg=true;this._run("run").finally(function(){e.resolve();t._dequeue()});return e}};RulesEngine.prototype._run=function(e){var t=false;var n=this;n.prevValues={};for(var i in n.evaluatedRules){n.prevValues[i]=n.evaluatedRules[i]}if(e!=="run")n.evaluatedRules={};n.rules.sort(function(e,t){if(n.rulesMap[e].priority>n.rulesMap[t].priority)return 1;if(n.rulesMap[e].priority<n.rulesMap[t].priority)return-1;if(n.prevToggle[e]<n.prevToggle[t])return 1;if(n.prevToggle[e]>n.prevToggle[t])return-1;return 0});var r=function(e){var i=new Zousan;if(t){Zousan.soon(function(){i.resolve()});return i}if(e===undefined){Zousan.soon(function(){i.resolve()});return i}var s=[];if(e.all!==undefined){e.all.forEach(function(e){s.push(r(e))});Zousan.all(s).then(function(){i.resolve()},function(){i.reject()})}else if(e.any!==undefined){e.any.forEach(function(e){s.push(function(){var t=new Zousan;r(e).then(function(){t.reject()},function(){t.resolve()});return t}())});Zousan.all(s).then(function(){i.reject()},function(){i.resolve()})}else{var o=e;var a=false;if(typeof o!=="string"){i.reject()}else{if(o.charAt(0)==="!"){a=true;o=o.slice(1)}if(n.rulesMap[o]!==undefined&&a===false){u(n.rulesMap[o]).then(function(){i.resolve()},function(){i.reject()})}else if(n.rulesMap[o]!==undefined&&a===true){u(n.rulesMap[o]).then(function(){i.reject()},function(){i.resolve()})}else{i.reject()}}}return i};var u=function(e){var i=new Zousan;if(t){Zousan.soon(function(){i.resolve()});return i}if(e===undefined){Zousan.soon(function(){i.resolve()});return i}if(n.evaluatedRules[e.name]===true){Zousan.soon(function(){i.resolve()});return i}if(n.evaluatedRules[e.name]===false){Zousan.soon(function(){i.reject()});return i}if(n.evaluatedRules[e.name]!==undefined&&typeof n.evaluatedRules[e.name].then==="function"){n.evaluatedRules[e.name].then(function(){i.resolve()},function(){i.reject()});return i}n.evaluatedRules[e.name]=i;var u=function(e,n,i){e.test(n.facts).then(function(){n.evaluatedRules[e.name]=true;if(n.prevValues[e.name]!==true)n.prevToggle[e.name]=new Date;if(!e.toggle||n.prevValues[e.name]!==true||((n.events[e.name]||{}).bound||{})._evaluation_event!==undefined){for(var r=0;r<e.events.length;r++){if(n.emit(e.events[r],n.isEvaluatingFlg)===true)t=true}}i.resolve()},function(){n.evaluatedRules[e.name]=false;if(n.prevValues[e.name]!==false)n.prevToggle[e.name]=new Date;if(((n.events[e.name]||{}).bound||{})._evaluation_event!==undefined)t=true;i.reject()})};if(e.conditions!==undefined){r(e.conditions).then(function(){u(e,n,i)},function(){n.evaluatedRules[e.name]=false;if(((n.events[e.name]||{}).bound||{})._evaluation_event!==undefined)t=true;i.reject()})}else{u(e,n,i)}return i};if(Object.keys(n.rulesMap).length===0){return Zousan.resolve()}var s=new Zousan;var o=function(e,t){t(e).finally(function(){if(e<n.rules.length-1){o(e+1,t)}else{s.resolve()}})};o(0,function(e){return u(n.rulesMap[n.rules[e]])});setTimeout(function(){if(s.state===undefined){n._log("error","Rules engine timed out.");s.reject()}},this.engineTimeout);return s};RulesEngine.prototype.evaluate=function(e,t){if(this.isRunningFlg){return this._enqueue(this.evaluate,this,[e,t])}this.isRunningFlg=true;this.isEvaluatingFlg=true;var n=new Zousan;var i=this.facts;var r={};for(var u in this.evaluatedRules){r[u]=this.evaluatedRules[u]}var s={};for(var u in this.prevValues){s[u]=this.prevValues[u]}var o={};for(var u in this.prevToggle){o[u]=this.prevToggle[u]}var a;var f=this;if(t!==undefined){this.facts=t}if(this.rulesMap[e]&&this.events[e]._auto_generated_===true){a=this.rulesMap[e].priority;this.rulesMap[e].priority=-Infinity}this.evaluatedRules={};this.prevValues={};this.on(e,"_evaluation_event",function(e){n.resolve()});this._run("evaluate").finally(function(){f.off(e,"_evaluation_event");f.facts=i;f.evaluatedRules=r;f.prevValues=s;f.prevToggle=o;if(a!==undefined){f.rulesMap[e].priority=a}f.isEvaluatingFlg=false;if(n.state===undefined){n.reject()}f._dequeue()});return n};RulesEngine.prototype._enqueue=function(e,t,n){var i=new Zousan;this.queue.push([e,t,n,i]);return i};RulesEngine.prototype._dequeue=function(){this.isRunningFlg=false;if(this.queue.length===0)return;var e=this.queue.shift();e[0].apply(e[1],e[2]).then(function(){e[3].resolve()},function(){e[3].reject()})};return RulesEngine});
