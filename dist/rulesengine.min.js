!function(e,t){if("function"==typeof define&&define.amd)define(t);else{var n=t();"object"!=typeof module?e[n.name]=n:module.exports=n}}(this,function(){var e;try{"undefined"==typeof $&&require("jsdom-no-contextify").env("",function(t,n){t?console.error(t):($=require("jquery")(n),e=$)})}catch(t){e=!function(e,t){if("function"==typeof define&&define.amd)define(t);else{var n=t();"object"!=typeof module?e[n.name]=n:module.exports=n}}(this,function(){var e="done fail isResolved isRejected promise then always pipe".split(" "),t=[].slice,n={_Deferred:function(){var e,t,n,r=[],i={done:function(){if(!n){var t,o,s,a,u,l=arguments;for(e&&(u=e,e=0),t=0,o=l.length;t<o;t++)a=typeof(s=l[t]),Array.isArray(s)&&(a="array"),"array"===a?i.done.apply(i,s):"function"===a&&r.push(s);u&&i.resolveWith(u[0],u[1])}return this},resolveWith:function(i,o){if(!n&&!e&&!t){o=o||[],t=1;try{for(;r[0];)r.shift().apply(i,o)}finally{e=[i,o],t=0}}return this},resolve:function(){return i.resolveWith(this,arguments),this},isResolved:function(){return!(!t&&!e)},cancel:function(){return n=1,r=[],this}};return i},Deferred:function(t){var r,i=n._Deferred(),o=n._Deferred(),s={then:function(e,t){return i.done(e).fail(t),this},always:function(){return i.done.apply(i,arguments).fail.apply(this,arguments)},fail:o.done,rejectWith:o.resolveWith,reject:o.resolve,isRejected:o.isResolved,pipe:function(e,t){return n.Deferred(function(n){var r={done:[e,"resolve"],fail:[t,"reject"]};for(var o in r)!function(e,t){var r,o=t[0],s=t[1];"function"==typeof o?i[e](function(){(r=o.apply(this,arguments))&&"function"==typeof r.promise?r.promise().then(n.resolve,n.reject):n[s](r)}):i[e](n[s])}(o,r[o])}).promise()},promise:function(t){if(null==t){if(r)return r;r=t={}}for(var n=e.length;n--;)t[e[n]]=i[e[n]];return t}};for(var a in s)i[a]=s[a];return i.done(o.cancel).fail(i.cancel),delete i.cancel,t&&t.call(i,i),i},when:function(e){var r=arguments,i=0,o=r.length,s=o,a=o<=1&&e&&"function"==typeof e.promise?e:n.Deferred();if(o>1){for(;i<o;i++)r[i]&&"function"==typeof r[i].promise?r[i].promise().then(function(e){return function(n){r[e]=arguments.length>1?t.call(arguments,0):n,--s||a.resolveWith(a,t.call(r,0))}}(i),a.reject):--s;s||a.resolveWith(a,r)}else a!==e&&a.resolveWith(a,o?[e]:[]);return a.promise()}};return n})}var t=function(t){this.facts={},this.rules=[],this.rulesMap={},this.evaluatedRules={},this.events={},this.isEvaluatingFlg=!1,void 0!==t&&(e=t)};return t.prototype.constructor=t,t.prototype.updateFacts=function(t,n){var r=e.Deferred();if("object"==typeof t)return this.evaluatedRules={},this.facts=t,this.run().always(function(){r.resolve()}),r},t.prototype.getFacts=function(e){var t=JSON.parse(JSON.stringify(this.facts));if(void 0===e||"string"!=typeof e)return t;for(var n=e.split("."),r=0;r<n.length;r++)if(void 0===(t=t[n[r]]))return;return t},t.prototype.addRule=function(t,n,r){if("string"==typeof t){if("function"!=typeof n?n=function(){return e.Deferred().resolve()}:void 0===(n(this.facts)||{}).then&&(n=function(t){return function(n){var r=e.Deferred();return t(n)?setTimeout(r.resolve,0):setTimeout(r.reject,0),r}}(n)),(Array.isArray(r)||"object"!=typeof r)&&(r={}),void 0===r.priority&&(r.priority=9),Array.isArray(r.events)||(void 0!==r.events?r.events=[r.events]:r.events=[]),void 0===this.rulesMap[t]&&this.rules.push(t),Array.isArray(r.events))for(var i=0;i<r.events.length;i++)"string"==typeof r.events[i]&&this.addEvent(r.events[i]);else"string"==typeof r.events&&this.addEvent(r.events);void 0===this.events[t]&&(this.addEvent(t),Object.defineProperty(this.events[t],"_auto_generated_",{value:!0})),r.events.push(t),this.rulesMap[t]={name:t,events:r.events,test:n,priority:r.priority,conditions:r.conditions}}},t.prototype.addRules=function(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++)Array.isArray(e[t])&&this.addRule.apply(this,e[t])},t.prototype.removeRule=function(e){for(var t=0;t<this.rules.length;t++)this.rules[t]===e&&this.rules.splice(t,1);delete this.rulesMap[e],this.events[e]&&!0===this.events[e]._auto_generated_&&delete this.events[e]},t.prototype.addEvent=function(e){this.events[e]={bound:{}}},t.prototype.addEvents=function(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++)Array.isArray(e[t])?this.addEvent.apply(this,e[t]):this.addEvent.call(this,e[t])},t.prototype.removeEvent=function(e){delete this.events[e]},t.prototype.emit=function(e,t){if(t)return void 0!==this.events[e].bound._evaluation_event&&(this.events[e].bound._evaluation_event(this.facts),!0);for(var n in this.events[e].bound)this.events[e].bound[n](this.facts);return!1},t.prototype.on=function(e,t,n){this.events[e].bound[t]=n},t.prototype.off=function(e,t){void 0!==t?delete this.events[e].bound[t]:this.events[e].bound={}},t.prototype.run=function(){var t=!1,n=this;n.rules.sort(function(e,t){return n.rulesMap[e].priority>n.rulesMap[t].priority?1:n.rulesMap[e].priority<n.rulesMap[t].priority?-1:0});var r=function(o){var s=e.Deferred();if(t)return s.resolve();if(void 0===o)return s.resolve();var a=[];if(void 0!==o.all)o.all.forEach(function(e){a.push(r(e))}),e.when.apply(e,a).done(function(){s.resolve()}).fail(function(){s.reject()});else if(void 0!==o.any)o.any.forEach(function(t){a.push(function(){var n=e.Deferred();return r(t).done(function(){n.reject()}).fail(function(){n.resolve()}),n}())}),e.when.apply(e,a).done(function(){s.reject()}).fail(function(){s.resolve()});else{var u=o,l=!1;"string"!=typeof u?s.reject():("!"===u.charAt(0)&&(l=!0,u=u.slice(1)),void 0!==n.rulesMap[u]&&!1===l?i(n.rulesMap[u]).done(function(){s.resolve()}).fail(function(){s.reject()}):void 0!==n.rulesMap[u]&&!0===l?i(n.rulesMap[u]).done(function(){s.reject()}).fail(function(){s.resolve()}):s.reject())}return s},i=function(i){var o=e.Deferred();return t?o.resolve():void 0===i?o.resolve():!0===n.evaluatedRules[i.name]?o.resolve():!1===n.evaluatedRules[i.name]?o.reject():void 0!==n.evaluatedRules[i.name]&&"function"==typeof n.evaluatedRules[i.name].always?(n.evaluatedRules[i.name].done(function(){o.resolve()}).fail(function(){o.reject()}),o):(n.evaluatedRules[i.name]=o,void 0!==i.conditions?r(i.conditions).done(function(){i.test(n.facts).done(function(){n.evaluatedRules[i.name]=!0;for(var e=0;e<i.events.length;e++)!0===n.emit(i.events[e],n.isEvaluatingFlg)&&(t=!0);o.resolve(),n.evaluatedRules[i.name]=!0}).fail(function(){void 0!==((n.events[i.name]||{}).bound||{})._evaluation_event&&(t=!0),n.evaluatedRules[i.name]=!1,o.reject(),n.evaluatedRules[i.name]=!1})}).fail(function(){void 0!==((n.events[i.name]||{}).bound||{})._evaluation_event&&(t=!0),o.reject(),n.evaluatedRules[i.name]=!1}):i.test(n.facts).done(function(){for(var e=0;e<i.events.length;e++)!0===n.emit(i.events[e],n.isEvaluatingFlg)&&(t=!0);o.resolve(),n.evaluatedRules[i.name]=!0}).fail(function(){void 0!==((n.events[i.name]||{}).bound||{})._evaluation_event&&(t=!0),o.reject(),n.evaluatedRules[i.name]=!1}),o)};if(0===Object.keys(n.rulesMap).length)return e.Deferred().resolve();var o=e.Deferred(),s=function(e,t){t(e).always(function(){e<n.rules.length?s(e+1,t):o.resolve()})};return s(0,function(e){return i(n.rulesMap[n.rules[e]])}),o},t.prototype.evaluate=function(t,n){var r,i=e.Deferred(),o=this.facts,s=JSON.stringify(this.evaluatedRules),a=this;return void 0!==n&&(this.facts=n),this.rulesMap[t]&&!0===this.events[t]._auto_generated_&&(r=this.rulesMap[t].priority,this.rulesMap[t].priority=-1/0),this.isEvaluatingFlg=!0,this.evaluatedRules={},this.on(t,"_evaluation_event",function(e){a.off(t,"_evaluation_event"),a.facts=o,a.evaluatedRules=JSON.parse(s),void 0!==r&&(a.rulesMap[t].priority=r),a.isEvaluatingFlg=!1,i.resolve()}),this.run().always(function(){a.off(t,"_evaluation_event"),a.facts=o,a.evaluatedRules=JSON.parse(s),void 0!==r&&(a.rulesMap[t].priority=r),a.isEvaluatingFlg=!1,i.reject()}),i},t});
