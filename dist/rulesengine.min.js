(function(root,e){if(typeof define==="function"&&define.amd){define([],e)}else if(typeof module==="object"&&module.exports){module.exports=e()}else{root.RulesEngine=e()}})(this,function(){var e=function(){var e=[];function t(){while(e.length){e[0]();e.shift()}}var n=function(){if(typeof MutationObserver!=="undefined"){var e=document.createElement("div");var n=new MutationObserver(t);n.observe(e,{attributes:true});return function(t){e.setAttribute("a",0)}}if(typeof setImmediate!=="undefined"){return function(){setImmediate(t)}}return function(){setTimeout(t,0)}}();return function(t){e.push(t);if(e.length==1)n()}}();var jQuery;try{if(typeof $==="undefined"){var t=require("jsdom-no-contextify");t.env("",function(e,t){if(e){console.error(e);return}$=require("jquery")(t);jQuery=$})}else{jQuery=$}}catch(e){console.error("jQuery not found.")}var RulesEngine=function(e){if(e===undefined){e={}}this.facts=e.facts||{};this.rules=e.rules||[];this.rulesMap=e.rulesMap||{};this.evaluatedRules=e.evaluatedRules||{};this.prevValues=e.prevValues||{};this.prevToggle=e.prevToggle||{};this.events=e.events||{};this.queue=e.queue||[];this.asyncTimeout=e.asyncTimeout||3e3;this.engineTimeout=e.engineTimeout||1e4;this.isEvaluatingFlg=e.isEvaluatingFlg||false;this.isRunningFlg=e.isRunningFlg||false;this.settings=e.settings||{deterministic:false};this.promise=e.promise;if(this.promise!==undefined){jQuery=this.promise}else if(jQuery.Deferred===undefined){throw new Error("No jQuery.Deferred or shim found.")}else{this.promise=jQuery}};RulesEngine.prototype.constructor=RulesEngine;RulesEngine.prototype._log=function(e,t){if(typeof console==="undefined"||typeof console[e]!=="function")return;console[e](t)};RulesEngine.prototype._extend=function(e,t){for(var n in t){e[n]=t[n]}return e};RulesEngine.prototype.updateFacts=function(e){var t=Array.prototype.slice.call(arguments);if(this.isRunningFlg){return this._enqueue(this.updateFacts,this,t)}this.isRunningFlg=true;var n=this;var r=jQuery.Deferred();var e={};try{t.map(function(t){if(typeof t!=="object")throw new Error("updateFacts() only accepts objects as arguments.");e=n._extend(e,t)});var i=[];for(var s in e){n.facts[s]=e[s];i.push(s)}for(var u in n.facts){if(i.indexOf(u)===-1){delete n.facts[u]}else{n.facts[u]=n._deepCopy(n.facts[u])}}}catch(e){this._log("error",e);r.resolve();n._dequeue();return r}this._run("updateFacts").always(function(){r.resolve();n._dequeue()});return r};RulesEngine.prototype._deepCopy=function(e){try{return JSON.parse(JSON.stringify(e))}catch(t){this._log(t);return e}};RulesEngine.prototype.getFacts=function(e){var t=this.facts;if(e===undefined||typeof e!=="string")return t;var n=e.split(".");for(var r=0;r<n.length;r++){t=t[n[r]];if(t===undefined)return undefined}return t};RulesEngine.prototype.copyFacts=function(e){return this._deepCopy(this.getFacts(e))};RulesEngine.prototype.addRule=function(t,n,r){if(this.settings.deterministic){n=new Function("return "+n)()}if(typeof t!=="string")return;if(this.rulesMap[t]!==undefined){this._log("warn","Rule has already been defined. Removing previous rule.");this.removeRule(t)}var i;var s=this;if(typeof n!=="function"){i=function(){var t=jQuery.Deferred();if(n||n===undefined){e(t.resolve)}else{e(t.reject)}return t}}else if((function(e){try{return n(e)}catch(e){return{}}}(this.facts)||{}).done===undefined){i=function(t){return function(n){var r=jQuery.Deferred();try{if(t(n)){e(r.resolve)}else{e(r.reject)}}catch(t){s._log("error",t);e(function(){if(r.state()==="pending")r.reject()})}return r}}(n)}else{i=function(r){var i=jQuery.Deferred();try{n(r).done(function(){i.resolve()}).fail(function(){i.reject()});setTimeout(function(){if(i.state()==="pending"){i.reject();s._log("error","Timed out for evaluation of function: "+t)}},s.asyncTimeout);return i}catch(t){s._log("error",t);e(function(){if(i.state()==="pending")i.reject()});return i}}}if(Array.isArray(r)||typeof r!=="object"){r={}}if(r.priority===undefined){r.priority=9}if(r.toggle===undefined){r.toggle=false}if(!Array.isArray(r.events)){if(r.events!==undefined){r.events=[r.events]}else{r.events=[]}}if(this.rulesMap[t]===undefined){this.rules.push(t)}if(Array.isArray(r.events)){for(var u=0;u<r.events.length;u++){if(typeof r.events[u]==="string"){this.addEvent(r.events[u])}}}else if(typeof r.events==="string"){this.addEvent(r.events)}if(this.events[t]===undefined){this.addEvent(t);Object.defineProperty(this.events[t],"_auto_generated_",{value:true})}r.events.push(t);this.rulesMap[t]={name:t,events:r.events,test:i,priority:r.priority,conditions:r.conditions,toggle:r.toggle};this.prevToggle[t]=new Date;delete this.evaluatedRules[t];delete this.prevValues[t]};RulesEngine.prototype.addRules=function(e){if(!Array.isArray(e))return false;for(var t=0;t<e.length;t++){if(Array.isArray(e[t])){this.addRule.apply(this,e[t])}}};RulesEngine.prototype.removeRule=function(e){for(var t=0;t<this.rules.length;t++){if(this.rules[t]===e){this.rules.splice(t,1)}}delete this.evaluatedRules[e];delete this.prevValues[e];delete this.prevToggle[e];delete this.rulesMap[e];if(this.events[e]&&this.events[e]._auto_generated_===true){delete this.events[e]}};RulesEngine.prototype.addEvent=function(e){this.events[e]={bound:{}}};RulesEngine.prototype.addEvents=function(e){if(!Array.isArray(e))return false;for(var t=0;t<e.length;t++){if(Array.isArray(e[t])){this.addEvent.apply(this,e[t])}else{this.addEvent.call(this,e[t])}}};RulesEngine.prototype.removeEvent=function(e){delete this.events[e]};RulesEngine.prototype.emit=function(e,t){if(t){if(this.events[e]&&this.events[e].bound._evaluation_event!==undefined){try{this.events[e].bound._evaluation_event(this.facts)}catch(e){this._log("error",e)}return true}return false}for(var n in this.events[e].bound){try{this.events[e].bound[n](this.facts)}catch(e){this._log("error",e)}}return false};RulesEngine.prototype.on=function(e,t,n){if(n===undefined&&typeof t==="function"){n=t;t=e}try{this.events[e].bound[t]=n}catch(e){this._log("error",e)}};RulesEngine.prototype.off=function(e,t){if(t!==undefined){delete this.events[e].bound[t]}else{this.events[e].bound={}}};RulesEngine.prototype.run=function(){if(this.isRunningFlg){return this._enqueue(this.run,this,[])}else{var e=jQuery.Deferred();var t=this;this.isRunningFlg=true;this._run("run").always(function(){e.resolve();t._dequeue()});return e}};RulesEngine.prototype._run=function(e){var t=false;var n=this;n.prevValues={};for(var r in n.evaluatedRules){n.prevValues[r]=n.evaluatedRules[r]}if(e!=="run")n.evaluatedRules={};n.rules.sort(function(e,t){if(n.rulesMap[e].priority>n.rulesMap[t].priority)return 1;if(n.rulesMap[e].priority<n.rulesMap[t].priority)return-1;if(n.prevToggle[e]<n.prevToggle[t])return 1;if(n.prevToggle[e]>n.prevToggle[t])return-1;return 0});var i=function(e){var r=jQuery.Deferred();if(t)return r.resolve();if(e===undefined){return r.resolve()}var u=[];if(e.all!==undefined){e.all.forEach(function(e){u.push(i(e))});jQuery.when.apply(jQuery,u).done(function(){r.resolve()}).fail(function(){r.reject()})}else if(e.any!==undefined){e.any.forEach(function(e){u.push(function(){var t=jQuery.Deferred();i(e).done(function(){t.reject()}).fail(function(){t.resolve()});return t}())});jQuery.when.apply(jQuery,u).done(function(){r.reject()}).fail(function(){r.resolve()})}else{var o=e;var a=false;if(typeof o!=="string"){r.reject()}else{if(o.charAt(0)==="!"){a=true;o=o.slice(1)}if(n.rulesMap[o]!==undefined&&a===false){s(n.rulesMap[o]).done(function(){r.resolve()}).fail(function(){r.reject()})}else if(n.rulesMap[o]!==undefined&&a===true){s(n.rulesMap[o]).done(function(){r.reject()}).fail(function(){r.resolve()})}else{r.reject()}}}return r};var s=function(e){var r=jQuery.Deferred();if(t)return r.resolve();if(e===undefined)return r.resolve();if(n.evaluatedRules[e.name]===true)return r.resolve();if(n.evaluatedRules[e.name]===false)return r.reject();if(n.evaluatedRules[e.name]!==undefined&&typeof n.evaluatedRules[e.name].always==="function"){n.evaluatedRules[e.name].done(function(){r.resolve()}).fail(function(){r.reject()});return r}n.evaluatedRules[e.name]=r;var s=function(e,n,r){e.test(n.facts).done(function(){n.evaluatedRules[e.name]=true;if(n.prevValues[e.name]!==true)n.prevToggle[e.name]=new Date;if(!e.toggle||n.prevValues[e.name]!==true||((n.events[e.name]||{}).bound||{})._evaluation_event!==undefined){for(var i=0;i<e.events.length;i++){if(n.emit(e.events[i],n.isEvaluatingFlg)===true)t=true}}r.resolve()}).fail(function(){n.evaluatedRules[e.name]=false;if(n.prevValues[e.name]!==false)n.prevToggle[e.name]=new Date;if(((n.events[e.name]||{}).bound||{})._evaluation_event!==undefined)t=true;r.reject()})};if(e.conditions!==undefined){i(e.conditions).done(function(){s(e,n,r)}).fail(function(){n.evaluatedRules[e.name]=false;if(((n.events[e.name]||{}).bound||{})._evaluation_event!==undefined)t=true;r.reject()})}else{s(e,n,r)}return r};if(Object.keys(n.rulesMap).length===0){return jQuery.Deferred().resolve()}var u=jQuery.Deferred();var o=function(e,r){r(e).always(function(){if(e<n.rules.length&&!t){o(e+1,r)}else{u.resolve()}})};o(0,function(e){return s(n.rulesMap[n.rules[e]])});setTimeout(function(){if(u.state()==="pending"){n._log("error","Rules engine timed out.");n.evaluatedRules={};u.reject()}},this.engineTimeout);return u};RulesEngine.prototype.evaluate=function(e,t){if(this.isRunningFlg){return this._enqueue(this.evaluate,this,[e,t])}this.isRunningFlg=true;this.isEvaluatingFlg=true;var n=jQuery.Deferred();var r=this.facts;var i={};for(var s in this.evaluatedRules){i[s]=this.evaluatedRules[s]}var u={};for(var s in this.prevValues){u[s]=this.prevValues[s]}var o={};for(var s in this.prevToggle){o[s]=this.prevToggle[s]}var a;var f=this;if(t!==undefined){this.facts=t}if(this.rulesMap[e]&&this.events[e]._auto_generated_===true){a=this.rulesMap[e].priority;this.rulesMap[e].priority=-Infinity}this.evaluatedRules={};this.prevValues={};this.on(e,"_evaluation_event",function(e){n.resolve()});this._run("evaluate").always(function(){f.off(e,"_evaluation_event");f.facts=r;f.evaluatedRules=i;f.prevValues=u;f.prevToggle=o;if(a!==undefined){f.rulesMap[e].priority=a}f.isEvaluatingFlg=false;if(n.state()==="pending"){n.reject()}f._dequeue()});return n};RulesEngine.prototype._enqueue=function(e,t,n){var r=jQuery.Deferred();this.queue.push([e,t,n,r]);return r};RulesEngine.prototype._dequeue=function(){this.isRunningFlg=false;if(this.queue.length===0)return;var e=this.queue.shift();e[0].apply(e[1],e[2]).done(function(){e[3].resolve()}).fail(function(){e[3].reject()})};return RulesEngine});
