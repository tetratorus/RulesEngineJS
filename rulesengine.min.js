window.RulesEngine=function(e){this.facts={},this.rules=[],this.rulesMap={},this.evaluatedRules={},this.events={},this.isEvaluatingFlg=!1,void 0!==e&&this.updateFacts(e)};RulesEngine.prototype.constructor=RulesEngine,RulesEngine.prototype.updateFacts=function(e){return deferred=$.Deferred(),this.evaluatedRules={},this.facts=e,this.run().always(function(){deferred.resolve()}),deferred},RulesEngine.prototype.addRule=function(e,t,n){if("string"==typeof e){if("function"!=typeof t)t=function(){return $.Deferred().resolve()};else if(void 0===(t(this.facts)||{}).then){var r=t;t=function(e){return function(t){var n=$.Deferred();return e(t)?setTimeout(n.resolve,0):setTimeout(n.reject,0),n}}(r)}if((Array.isArray(n)||"object"!=typeof n)&&(n={}),void 0===n.priority&&(n.priority=9),Array.isArray(n.events)||(void 0!==n.events?n.events=[n.events]:n.events=[]),void 0===this.rulesMap[e]&&this.rules.push(e),Array.isArray(n.events))for(var i=0;i<n.events.length;i++)"string"==typeof n.events[i]&&this.addEvent(n.events[i]);else"string"==typeof n.events&&this.addEvent(n.events);void 0===this.events[e]&&(this.addEvent(e),Object.defineProperty(this.events[e],"_auto_generated_",{value:!0})),n.events.push(e),this.rulesMap[e]={name:e,events:n.events,test:t,priority:n.priority,conditions:n.conditions}}},RulesEngine.prototype.addRules=function(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++)Array.isArray(e[t])&&this.addRule.apply(this,e[t])},RulesEngine.prototype.removeRule=function(e){for(var t=0;t<this.rules.length;t++)this.rules[t]===e&&this.rules.splice(t,1);delete this.rulesMap[e],this.events[e]&&this.events[e]._auto_generated_===!0&&delete this.events[e]},RulesEngine.prototype.addEvent=function(e){this.events[e]={bound:{}}},RulesEngine.prototype.addEvents=function(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++)Array.isArray(e[t])?this.addEvent.apply(this,e[t]):this.addEvent.call(this,e[t])},RulesEngine.prototype.removeEvent=function(e){delete this.events[e]},RulesEngine.prototype.emit=function(e){if(this.isEvaluatingFlg)return void 0!==this.events[e].bound._evaluation_event?(this.events[e].bound._evaluation_event(this.facts),!0):!1;for(var t in this.events[e].bound)this.events[e].bound[t](this.facts);return!1},RulesEngine.prototype.on=function(e,t,n){void 0===this.events[e]&&this.addEvent(e),this.events[e].bound[t]=n},RulesEngine.prototype.off=function(e,t){void 0!==t?delete this.events[e].bound[t]:this.events[e].bound={}},RulesEngine.prototype.run=function(){var e=!1,t=this;t.rules.sort(function(e,n){return t.rulesMap[e].priority>t.rulesMap[n].priority});var n=function(i){var s=$.Deferred();if(e)return s.resolve();if(void 0===i)return s.resolve();var o=[];if(void 0!==i.all){for(var a=0;a<i.all.length;a++)o.push(n(i.all[a]));$.when.apply($,o).done(function(){s.resolve()}).fail(function(){s.reject()})}else if(void 0!==i.any){for(var a=0;a<i.any.length;a++)o.push(function(){var e=$.Deferred();return n(i.any[a]).done(function(){e.reject()}).fail(function(){e.resolve()}),e}());$.when.apply($,o).done(function(){s.reject()}).fail(function(){s.resolve()})}else{var u=i,l=!1;"string"!=typeof u?s.reject():("!"===u.charAt(0)&&(l=!0,u=u.slice(1)),void 0!==t.rulesMap[u]&&l===!1?r(t.rulesMap[u]).done(function(){s.resolve()}).fail(function(){s.reject()}):void 0!==t.rulesMap[u]&&l===!0?r(t.rulesMap[u]).done(function(){s.reject()}).fail(function(){s.resolve()}):s.reject())}return s},r=function(r){var i=$.Deferred();return e?i.resolve():void 0===r?i.resolve():t.evaluatedRules[r.name]===!0?i.resolve():t.evaluatedRules[r.name]===!1?i.reject():void 0!==t.evaluatedRules[r.name]&&"function"==typeof t.evaluatedRules[r.name].always?(t.evaluatedRules[r.name].done(function(){i.resolve()}).fail(function(){i.reject()}),i):(t.evaluatedRules[r.name]=i,void 0!==r.conditions?n(r.conditions).done(function(){r.test(t.facts).done(function(){t.evaluatedRules[r.name]=!0;for(var n=0;n<r.events.length;n++)t.emit(r.events[n])===!0&&(e=!0);i.resolve()}).fail(function(){t.evaluatedRules[r.name]=!1,i.reject()})}).fail(function(){i.reject()}):r.test(t.facts).done(function(){t.evaluatedRules[r.name]=!0;for(var n=0;n<r.events.length;n++)t.emit(r.events[n],t.isEvaluatingFlg)===!0&&(e=!0);i.resolve()}).fail(function(){t.evaluatedRules[r.name]=!1,i.reject()}),i)};if(0===Object.keys(t.rulesMap).length)return $.Deferred().resolve();var i=$.Deferred(),s=function(e,n){n(e).always(function(){e<t.rules.length?s(e+1,n):i.resolve()})};return s(0,function(e){return r(t.rulesMap[t.rules[e]])}),i},RulesEngine.prototype.evaluate=function(e,t){var n,r=$.Deferred(),i=this.facts,s=JSON.stringify(this.evaluatedRules),o=this;return void 0!==t&&(this.facts=t),this.rulesMap[e]&&this.events[e]._auto_generated_===!0&&(n=this.rulesMap[e].priority,this.rulesMap[e].priority=-(1/0)),this.isEvaluatingFlg=!0,this.on(e,"_evaluation_event",function(t){o.off(e,"_evaluation_event"),o.facts=i,o.evaluatedRules=JSON.parse(s),void 0!==n&&(o.rulesMap[e].priority=n),o.isEvaluatingFlg=!1,r.resolve()}),this.run().always(function(){o.off(e,"_evaluation_event"),o.facts=i,o.evaluatedRules=JSON.parse(s),void 0!==n&&(o.rulesMap[e].priority=n),o.isEvaluatingFlg=!1,r.reject()}),r},RulesEngine.prototype.getFacts=function(e){for(var t=e.split("."),n=this.facts,r=0;r<t.length;r++)if(n=n[t[r]],void 0===n)return void 0;return n};
