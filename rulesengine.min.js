window.RulesEngine=function(e){this.facts={},this.rules=[],this.rulesMap={},this.evaluatedRules={},this.events={},this.isEvaluatingFlg=!1,void 0!==e&&this.updateFacts(e)};RulesEngine.prototype.constructor=RulesEngine,RulesEngine.prototype.updateFacts=function(e,t){var n=$.Deferred();if("object"==typeof e)return this.evaluatedRules={},this.facts=e,this.run().always(function(){n.resolve()}),n;if("string"==typeof e){for(var i=e,s=i.split("."),r=this.facts,o=0;o<s.length-1;o++)if(r=r[s[o]],void 0===r)return this.evaluatedRules={},this.run().always(function(){n.resolve()}),n;return r[s[s.length-1]]=t,this.evaluatedRules={},this.run().always(function(){n.resolve()}),n}},RulesEngine.prototype.addRule=function(e,t,n){if("string"==typeof e){if("function"!=typeof t)t=function(){return $.Deferred().resolve()};else if(void 0===(t(this.facts)||{}).then){var i=t;t=function(e){return function(t){var n=$.Deferred();return e(t)?setTimeout(n.resolve,0):setTimeout(n.reject,0),n}}(i)}if((Array.isArray(n)||"object"!=typeof n)&&(n={}),void 0===n.priority&&(n.priority=9),Array.isArray(n.events)||(void 0!==n.events?n.events=[n.events]:n.events=[]),void 0===this.rulesMap[e]&&this.rules.push(e),Array.isArray(n.events))for(var s=0;s<n.events.length;s++)"string"==typeof n.events[s]&&this.addEvent(n.events[s]);else"string"==typeof n.events&&this.addEvent(n.events);void 0===this.events[e]&&(this.addEvent(e),Object.defineProperty(this.events[e],"_auto_generated_",{value:!0})),n.events.push(e),this.rulesMap[e]={name:e,events:n.events,test:t,priority:n.priority,conditions:n.conditions}}},RulesEngine.prototype.addRules=function(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++)Array.isArray(e[t])&&this.addRule.apply(this,e[t])},RulesEngine.prototype.removeRule=function(e){for(var t=0;t<this.rules.length;t++)this.rules[t]===e&&this.rules.splice(t,1);delete this.rulesMap[e],this.events[e]&&this.events[e]._auto_generated_===!0&&delete this.events[e]},RulesEngine.prototype.addEvent=function(e){this.events[e]={bound:{}}},RulesEngine.prototype.addEvents=function(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++)Array.isArray(e[t])?this.addEvent.apply(this,e[t]):this.addEvent.call(this,e[t])},RulesEngine.prototype.removeEvent=function(e){delete this.events[e]},RulesEngine.prototype.emit=function(e){if(this.isEvaluatingFlg)return void 0!==this.events[e].bound._evaluation_event?(this.events[e].bound._evaluation_event(this.facts),!0):!1;for(var t in this.events[e].bound)this.events[e].bound[t](this.facts);return!1},RulesEngine.prototype.on=function(e,t,n){void 0===this.events[e]&&this.addEvent(e),this.events[e].bound[t]=n},RulesEngine.prototype.off=function(e,t){void 0!==t?delete this.events[e].bound[t]:this.events[e].bound={}},RulesEngine.prototype.run=function(){var e=!1,t=this;t.rules.sort(function(e,n){return t.rulesMap[e].priority>t.rulesMap[n].priority});var n=function(s){var r=$.Deferred();if(e)return r.resolve();if(void 0===s)return r.resolve();var o=[];if(void 0!==s.all){for(var a=0;a<s.all.length;a++)o.push(n(s.all[a]));$.when.apply($,o).done(function(){r.resolve()}).fail(function(){r.reject()})}else if(void 0!==s.any){for(var a=0;a<s.any.length;a++)o.push(function(){var e=$.Deferred();return n(s.any[a]).done(function(){e.reject()}).fail(function(){e.resolve()}),e}());$.when.apply($,o).done(function(){r.reject()}).fail(function(){r.resolve()})}else{var u=s,l=!1;"string"!=typeof u?r.reject():("!"===u.charAt(0)&&(l=!0,u=u.slice(1)),void 0!==t.rulesMap[u]&&l===!1?i(t.rulesMap[u]).done(function(){r.resolve()}).fail(function(){r.reject()}):void 0!==t.rulesMap[u]&&l===!0?i(t.rulesMap[u]).done(function(){r.reject()}).fail(function(){r.resolve()}):r.reject())}return r},i=function(i){var s=$.Deferred();return e?s.resolve():void 0===i?s.resolve():t.evaluatedRules[i.name]===!0?s.resolve():t.evaluatedRules[i.name]===!1?s.reject():void 0!==t.evaluatedRules[i.name]&&"function"==typeof t.evaluatedRules[i.name].always?(t.evaluatedRules[i.name].done(function(){s.resolve()}).fail(function(){s.reject()}),s):(t.evaluatedRules[i.name]=s,void 0!==i.conditions?n(i.conditions).done(function(){i.test(t.facts).done(function(){t.evaluatedRules[i.name]=!0;for(var n=0;n<i.events.length;n++)t.emit(i.events[n])===!0&&(e=!0);s.resolve()}).fail(function(){t.evaluatedRules[i.name]=!1,s.reject()})}).fail(function(){s.reject()}):i.test(t.facts).done(function(){t.evaluatedRules[i.name]=!0;for(var n=0;n<i.events.length;n++)t.emit(i.events[n],t.isEvaluatingFlg)===!0&&(e=!0);s.resolve()}).fail(function(){t.evaluatedRules[i.name]=!1,s.reject()}),s)};if(0===Object.keys(t.rulesMap).length)return $.Deferred().resolve();var s=$.Deferred(),r=function(e,n){n(e).always(function(){e<t.rules.length?r(e+1,n):s.resolve()})};return r(0,function(e){return i(t.rulesMap[t.rules[e]])}),s},RulesEngine.prototype.evaluate=function(e,t){var n,i=$.Deferred(),s=this.facts,r=JSON.stringify(this.evaluatedRules),o=this;return void 0!==t&&(this.facts=t),this.rulesMap[e]&&this.events[e]._auto_generated_===!0&&(n=this.rulesMap[e].priority,this.rulesMap[e].priority=-(1/0)),this.isEvaluatingFlg=!0,this.on(e,"_evaluation_event",function(t){o.off(e,"_evaluation_event"),o.facts=s,o.evaluatedRules=JSON.parse(r),void 0!==n&&(o.rulesMap[e].priority=n),o.isEvaluatingFlg=!1,i.resolve()}),this.run().always(function(){o.off(e,"_evaluation_event"),o.facts=s,o.evaluatedRules=JSON.parse(r),void 0!==n&&(o.rulesMap[e].priority=n),o.isEvaluatingFlg=!1,i.reject()}),i},RulesEngine.prototype.getFacts=function(e){for(var t=e.split("."),n=this.facts,i=0;i<t.length;i++)if(n=n[t[i]],void 0===n)return void 0;return n};
